{% extends 'template.html' %}

{% block content %}

{% if module_version %}

<script>
    function selectModuleTab(event, tab_name) {
        tab_name = "module-tab-" + tab_name;
        var i, tabcontent, tablinks;

        // Hide content of all tabs
        tabcontent = document.getElementsByClassName("module-tabs");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Remove 'active' from all tab links
        tablinks = document.getElementsByClassName("module-tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" is-active", "");
        }
        // Show content of current tab and mark current link as active.
        document.getElementById(tab_name).style.display = "block";
        event.target.parentNode.className += " is-active";
    }
    $.get("/v1/modules/{{ module_provider.id }}/downloads/summary", function(data, status) {
        Object.keys(data.data.attributes).forEach((key) => {
            $(`#downloads-${key}`).html(data.data.attributes[key]);
        });
    });

    $.get("/v1/terrareg/analytics/{{ module_provider.id }}/token_versions", (data, status) => {
        Object.keys(data).forEach((token) => {
            $('#analyticsVersionByTokenTable').append(`
                <tr>
                    <td>
                        ${token}
                    </td>
                    <td>
                        ${data[token].module_version}
                    </td>
                    <td>
                        ${data[token].terraform_version}
                    </td>
                </tr>
            `);
        });
        $('#analytics-table').DataTable();
    });

    function update_module_provider_settings(ev) {
        $('#settings-status-success').css('display', 'none');
        $('#settings-status-error').css('display', 'none');
        $.post({
            url: '/v1/terrareg/modules/{{ module_provider.id }}/settings',
            data: JSON.stringify({
                git_provider_id: $('select[id=settings-git-provider] option').filter(':selected').val(),
                clone_url_template: $('#settings-clone-url-template').val(),
                browse_url_template: $('#settings-browse-url-template').val(),
                git_tag_format: $('#settings-git-tag-format').val(),
                verified: $('#settings-verified').is(':checked'),
                csrf_token: '{{ csrf_token }}'
            }),
            contentType: 'application/json'
        }).done(() => {
            $('#settings-status-success').css('display', 'block');
        }).fail((res) => {
            if (res.responseJSON && res.responseJSON.message) {
                $('#settings-status-error').html(res.responseJSON.message);
            } else {
                $('#settings-status-error').html('An unexpected error occurred');
            }
            $('#settings-status-error').css('display', 'block');
        });
    }

    function selectSubmodule(event) {
        let target_obj = $(event.target)[0].selectedOptions[0];
        let url = target_obj.value;

        // Ignore selection of 'Select modules' item
        if (url == 'none') {
            return;
        }
        // Navigate page to submodule
        window.location.href = url;
    }

</script>

{% endif %}


<nav class="breadcrumb" aria-label="breadcrumbs">
    <ul>
        <li><a href="/modules">Modules</a></li>
        <li><a href="/modules/{{ namespace.name }}">{{ namespace.name }}</a></li>
        <li><a href="/modules/{{ namespace.name }}/{{ module.name }}">{{ module.name }}</a></li>
        {% block module_breadcrumb %}{% endblock %}
    </ul>
</nav>

<div class="columns" style="background-color: #f9f9f9; padding-top: 30px; padding-bottom: 30px;">
    <div class="column is-two-fifths is-offset-one-fifth">
        {% block main_details %}{% endblock %}
    </div>

    {% if module_version %}
    <div class="column is-one-fifth">

        {% if not current_module.is_submodule %}
        <div class="box">
            <table class="table">
                <thead>
                    <tr>
                        <th>Module Downloads</th>
                        <th>
                            <span class="tag is-warning is-light">All Versions</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Downloads this week</td>
                        <td id="downloads-week"></td>
                    </tr>
                    <tr>
                        <td>Downloads this month</td>
                        <td id="downloads-month"></td>
                    </tr>
                    <tr>
                        <td>Downloads this year</td>
                        <td id="downloads-year"></td>
                    </tr>
                    <tr>
                        <td>Downloads over all time</td>
                        <td id="downloads-total"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}


        <div class="box">
            <h5 class="title is-5">Usage</h4>
            <pre>
module "{{ module.name }}" {
    source  = "{{ server_hostname }}/{{ current_module.id }}"
    version = "{{ module_version.version }}"

    # Provide variables here
    # See 'Resource Builder' tab for an interactive builder
    # example = "value"
}</pre>
        </div>
    </div>
    {% endif %}
</div>


{% if current_module %}
<div class="tabs">
    <ul>
        <li class="module-tab-link is-active"><a onclick="selectModuleTab(event, 'readme')">Readme</a></li>
        <li class="module-tab-link"><a onclick="selectModuleTab(event, 'inputs')">Inputs</a></li>
        <li class="module-tab-link"><a onclick="selectModuleTab(event, 'outputs')">Outputs</a></li>
        <li class="module-tab-link"><a onclick="selectModuleTab(event, 'dependencies')">Dependencies</a></li>
        <li class="module-tab-link">
            <a onclick="selectModuleTab(event, 'resources')">Resources</a>
        </li>

        {% if not current_module.is_submodule %}
        <li class="module-tab-link">
            <a onclick="selectModuleTab(event, 'analytics')">
                Analytics
                <span class="tag is-warning is-light">Terrareg Exclusive</span>
            </a>
        </li>
        <li id="usageBuilderTabButton" class="module-tab-link">
            <a onclick="selectModuleTab(event, 'usage-builder')">
                Usage Builder
                <span class="tag is-warning is-light">Terrareg Exclusive</span>
            </a>
        </li>
        <li style="display: none" id="settingsTabButton" class="module-tab-link">
            <a onclick="selectModuleTab(event, 'settings')">
                Settings
            </a>
        </li>
        {% endif %}
    </ul>
</div>

<div class="columns">
    <div class="column is-three-fifths is-offset-one-fifth">

        <div id="module-tab-readme" class="module-tabs">
            {{ current_module.get_readme_html()|safe }}
        </div>
        <div id="module-tab-inputs" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Default value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for input in current_module.get_terraform_inputs() %}
                    <tr>
                        <td>
                            {{ input['name'] }}
                        </td>
                        <td>
                            {{ input['description'] }}
                        </td>
                        <td>
                            {{ input['type'] }}
                        </td>
                        <td>
                            {{ input['default'] if not input['required'] else 'Required' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="module-tab-outputs" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for output in current_module.get_terraform_outputs() %}
                    <tr>
                        <td>
                            {{ output['name'] }}
                        </td>
                        <td>
                            {{ output['description'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="module-tab-dependencies" class="module-tabs" style="display: none;">
            DEPENDENCIES
        </div>
        <div id="module-tab-resources" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Provider</th>
                        <th>Source</th>
                        <th>Mode</th>
                        <th>Version</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resource in current_module.get_terraform_resources() %}
                    <tr>
                        <td>
                            {{ resource['type'] }}
                        </td>
                        <td>
                            {{ resource['name'] }}
                        </td>
                        <td>
                            {{ resource['provider'] }}
                        </td>
                        <td>
                            {{ resource['source'] }}
                        </td>
                        <td>
                            {{ resource['mode'] }}
                        </td>
                        <td>
                            {{ resource['version'] }}
                        </td>
                        <td>
                            {{ resource['description'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not current_module.is_submodule %}
        <div id="module-tab-analytics" class="module-tabs" style="display: none;">
            <table id="analytics-table" class="table" style="width: 100%">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Module Version</th>
                        <th>Terraform Version</th>
                    </tr>
                </thead>
                <tbody id="analyticsVersionByTokenTable">
                </tbody>
            </table>
        </div>

        <div id="module-tab-usage-builder" class="module-tabs" style="display: none;">
            <table id="analytics-table" class="table" style="width: 100%">
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Description</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="usageBuilderTable">
                </tbody>
            </table>
            <pre id="usageBuilderOutput">
            </pre>
        </div>

        <!-- Module settings tab -->
        <div id="module-tab-settings" class="module-tabs" style="display: none;">
            <div class="field is-vertical">
                <div id="settings-status-success" style="display: none" class="notification is-success">
                    Settings Updated
                </div>
                <div id="settings-status-error" style="display: none" class="notification is-danger">
                </div>
                <form onsubmit="update_module_provider_settings(event); event.preventDefault();">
                    <div class="field">
                        <label class="label">Verified</label>
                        <div class="control">
                            <input class="checkbox" type="checkbox" value="true" id="settings-verified"
                                {% if module_provider.verified %}checked{% endif %}>
                        </div>
                        {% if namespace.is_auto_verified %}
                        All modules within this namespace are automatically approved on creation.
                        {% endif %}
                    </div>

                    <div class="field">
                        <label class="label">Git Repository Provider</label>
                        <div class="control select">
                            <select id="settings-git-provider">

                                {% if ALLOW_CUSTOM_GIT_URL_MODULE_PROVIDER or ALLOW_CUSTOM_GIT_URL_MODULE_VERSION %}
                                <option value=""
                                        {% if not module_provider.get_git_provider() %}
                                        selected
                                        {% endif %}>
                                    Custom
                                </option>
                                {% endif %}

                                {% for git_provider in git_providers %}
                                <option
                                    value="{{ git_provider.pk }}"
                                    {% if module_provider.get_git_provider() and
                                        module_provider.get_git_provider().name == git_provider.name
                                        %}selected{% endif %}>

                                    {{ git_provider.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    {% if ALLOW_CUSTOM_GIT_URL_MODULE_PROVIDER %}
                    <div class="field">
                        <label class="label">Custom Repository URL</label>
                        <div class="control">
                            <input placeholder="ssh://git@github.com/{{ namespace.name }}/{{ module.name }}-{{ module_provider.name }}.git" class="input" type="text" value="{{ module_provider._get_db_row()['clone_url_template'] or '' }}" id="settings-clone-url-template">
                        </div>
                        This URL must be valid for cloning the repository.<br />
                        It may include templated values, such as: <code>{namespace}</code>, <code>{module}</code>, <code>{provider}</code>>.<br />
                        E.g. <code>ssh://git@github.com/{namespace}/{module}-{provider}.git</code><br />
                        NOTE: Setting this field will override the repository provider configuration.
                    </div>
                    <div class="field">
                        <label class="label">Custom Repository browse URL</label>
                        <div class="control">
                            <input placeholder="https://github.com/{{ namespace.name }}/{{ module.name }}-{{ module_provider.name }}/tree/{tag}/{path}" class="input" type="text" value="{{ module_provider._get_db_row()['clone_url_template'] or '' }}" id="settings-browse-url-template">
                        </div>
                        This URL must be valid for browsing the source code of the repository.<br />
                        It may include templated values, such as: <code>{namespace}</code>, <code>{module}</code>, <code>{provider}</code>.<br />
                        It must include the following template values: <code>code>{tag}</code> and {path}</code><br />
                        E.g. <code>https://github.com/{namespace}/{module}-{provider}/tree/{tag}/{path}</code><br />
                        NOTE: Setting this field will override the repository provider configuration.
                    </div>
                    {% endif %}

                    <div class="field">
                        <label class="label">Git tag format</label>
                        <div class="control">
                            <input placeholder="v{version}" class="input" type="text" value="{{ module_provider.git_tag_format or '' }}" id="settings-git-tag-format">
                        </div>
                        This value will be converted to the expected git tag for a module version.<br />
                        {version} will be replaced by the actual module version.<br />
                        For example <code>v{version}</code> will translate to a git tag 'v1.1.1' for module version '1.1.1'
                    </div>
    
                    <div class="field">
                        <div class="control">
                        <button class="button is-link">Update</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    var input_variables;

    function usageBuilderQuoteString(input) {
        // Place input value directly into double quotes.
        // Escape backslashes and then escape double quotes.
        return '"' + input.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"';
    }

    function updateUsageBuilderOutput() {
        let output_tf = '';
        let additional_content = '';

        input_variables.forEach((input_variable) => {
            let input_id = `#usageBuilderInput-${input_variable.name}`;
            let var_input = '';

            // Get value from
            if (input_variable.type == 'static')
            {
                var_input = input_variable.value;
            }
            else if (input_variable.type == 'text')
            {
                var_input = $(input_id)[0].value;
            }
            else if (input_variable.type == 'boolean')
            {
                var_input = $(input_id).is(':checked') ? 'true' : 'false';
            }
            else if (input_variable.type == 'select')
            {
                let select_index = $(input_id)[0].value;
                let custom_input_id = `${input_id}-customValue`;

                // Check if custom type
                if (select_index == 'custom') {
                    // Display custom text input
                    $(custom_input_id)[0].style.display ='block';

                    // Use value of custom input as output
                    var_input = $(custom_input_id)[0].value
                }
                else
                {
                    // Hide custom input and clear value
                    $(custom_input_id)[0].style.display = 'none';
                    $(custom_input_id)[0].value = '';

                    // If choice is a string, add the choice name to as the value
                    if (typeof input_variable.choices[select_index] === 'string') {
                        var_input = input_variable.choices[select_index];
                    } else {
                        // Otherwise, use the attribute for the value
                        var_input = input_variable.choices[select_index].value;

                        // If object has additional_content, add it to the TF output
                        if (input_variable.choices[select_index].additional_content) {
                            additional_content += input_variable.choices[select_index].additional_content + '\n\n';
                        }
                    }
                }
                
            }

            if (input_variable.quote_value) {
                var_input = usageBuilderQuoteString(var_input);
            }

            output_tf += `\n    ${input_variable.name} = ${var_input}`;
        });


        $('#usageBuilderOutput').html(`
${additional_content}
module "{{ module.name }}" {
    source  = "{{ server_hostname }}/{{ module_provider.id }}"
    version = "{{ module_version.version }}"
${output_tf}
}
`);
    }

    $.get("/v1/terrareg/modules/{{ module_version.id }}/variable_template", (data, status) => {
        // Populate input_variables from response
        input_variables = data;

        if (! input_variables.length) {
            $('#usageBuilderTabButton').remove();
            return;
        }

        // Build input table
        input_variables.forEach((input_variable) => {
            let input_html = '';
            let input_id = `usageBuilderInput-${input_variable.name}`;

            if (input_variable.type == 'text') {
                input_html = `<input onkeyup="updateUsageBuilderOutput();" class="input" type="text" id="${input_id}" />`;

            } else if (input_variable.type == 'boolean') {
                input_html = `<input onchange="updateUsageBuilderOutput();" class="checkbox" type="checkbox" id="${input_id}" value="true">`;

            } else if (input_variable.type == 'select') {
                input_html = `<div class="select"><select onchange="updateUsageBuilderOutput();" id="${input_id}">`;
                input_variable.choices.forEach((input_choice, itx) => {
                    // If choices is list of strings, use the string as the name,
                    // otherwise, use name attribute of object.
                    let input_name = typeof input_choice === 'string' ? input_choice : input_choice.name;
                    input_html += `<option value="${itx}">${input_name}</option>`;
                });
                // If custom input is available, add to select
                if (input_variable.allow_custom) {
                    input_html += `<option value="custom">Custom Value</option>`;
                }
                input_html += '</select></div>';

                // If custom input is available, add hidden input for custom input
                input_html += `<input class="input" type="text" id="${input_id}-customValue" onkeyup="updateUsageBuilderOutput();" style="display: none;">`;

            } else {
                // Skip displaying other types of variables in input
                return;
            }

            $('#usageBuilderTable').append(`
                <tr>
                    <td>${input_variable.name}</td>
                    <td>${input_variable.additional_help === undefined ? '' : input_variable.additional_help}</td>
                    <td>${input_html}</td>
                </tr>
            `);
        });
    });

    // Check if user is authenticated and display settings tab
    is_logged_in((logged_in) => {
        if (logged_in) {
            $('#settingsTabButton').css('display', 'block');
        }
    });
</script>

{% endif %}


{% endblock %}
