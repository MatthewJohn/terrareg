{% extends 'template.html' %}

{% block content %}

{% if module_version %}

<script>
    async function populatePageDetails() {
        let details = await getModuleDetails('{{ module_provider.id }}');

        $.get(`/v1/modules/${details.module_provider_id}/downloads/summary`, function(data, status) {
            Object.keys(data.data.attributes).forEach((key) => {
                $(`#downloads-${key}`).html(data.data.attributes[key]);
            });
        });

        $.get(`/v1/terrareg/analytics/${details.module_provider_id}/token_versions`, (data, status) => {
            Object.keys(data).forEach((token) => {
                $('#analyticsVersionByTokenTable').append(`
                    <tr>
                        <td>
                            ${token}
                        </td>
                        <td>
                            ${data[token].module_version}
                        </td>
                        <td>
                            ${data[token].terraform_version}
                        </td>
                        <td>
                            ${data[token].environment}
                        </td>
                    </tr>
                `);
            });
            $('#analytics-table').DataTable();
        });

        addModuleLabels(details, $('#module-title'));
    }

    $(document).ready(function() {
        populatePageDetails();
    });


</script>

{% endif %}

<script>
    function selectModuleTab(tab_name, redirect) {
        if (redirect !== false) {
            // Set URL anchor to selected tag
            window.location.hash = '#' + tab_name;
        }

        let tab_content_id = "module-tab-" + tab_name;
        let tab_link_id = "module-tab-link-" + tab_name;
        let i, tabcontent, tablinks;

        // Hide content of all tabs
        tabcontent = document.getElementsByClassName("module-tabs");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Remove 'active' from all tab links
        tablinks = document.getElementsByClassName("module-tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" is-active", "");
        }
        // Show content of current tab and mark current link as active.
        document.getElementById(tab_content_id).style.display = "block";
        document.getElementById(tab_link_id).className += " is-active";
    }


    function update_module_provider_settings(ev) {
        $('#settings-status-success').css('display', 'none');
        $('#settings-status-error').css('display', 'none');
        $.post({
            url: '/v1/terrareg/modules/{{ module_provider.id }}/settings',
            data: JSON.stringify({
                git_provider_id: $('select[id=settings-git-provider] option').filter(':selected').val(),
                repo_base_url_template: $('#settings-base-url-template').val(),
                repo_clone_url_template: $('#settings-clone-url-template').val(),
                repo_browse_url_template: $('#settings-browse-url-template').val(),
                git_tag_format: $('#settings-git-tag-format').val(),
                verified: $('#settings-verified').is(':checked'),
                csrf_token: '{{ csrf_token }}'
            }),
            contentType: 'application/json'
        }).done(() => {
            $('#settings-status-success').css('display', 'block');
        }).fail((res) => {
            if (res.responseJSON && res.responseJSON.message) {
                $('#settings-status-error').html(res.responseJSON.message);
            } else {
                $('#settings-status-error').html('An unexpected error occurred');
            }
            $('#settings-status-error').css('display', 'block');
        });
    }

    function selectSubmodule(event) {
        let target_obj = $(event.target)[0].selectedOptions[0];
        let url = target_obj.value;

        // Ignore selection of 'Select modules' item
        if (url == 'none') {
            return;
        }
        // Navigate page to submodule
        window.location.href = url;
    }

    function selectVersion(event) {
        let target_obj = $(event.target)[0].selectedOptions[0];
        let url = target_obj.value;

        // Navigate page to version
        window.location.href = url;
    }

    $(document).ready(function () {
        let window_hash_value = $(location).attr('hash').replace('#', '');
        if (window_hash_value) {
            selectModuleTab(window_hash_value, false);
        }
        // If file list (for example) is present, select the tab
        else if ($('#module-tab-example-files').length) {
            selectModuleTab('example-files');
        }
        // If readme file is present, select the tab
        else if ($('#module-tab-link-readme').length) {
            selectModuleTab('readme', false);

        // otherwise, default to inputs tab
        } else {
            selectModuleTab('inputs', false);
        }
    });
</script>


<nav class="breadcrumb" aria-label="breadcrumbs">
    <ul>
        <li><a href="/modules">Modules</a></li>
        <li><a href="/modules/{{ namespace.name }}">{{ namespace.name }}</a></li>
        <li><a href="/modules/{{ namespace.name }}/{{ module.name }}">{{ module.name }}</a></li>
        {% block module_breadcrumb %}{% endblock %}
    </ul>
</nav>

<div class="columns is-centered" style="background-color: #f9f9f9; padding-top: 30px; padding-bottom: 30px;">

    {% if provider_logo.exists %}
    <a style="margin-top: 30px; max-height: 150px;" href="{{ provider_logo.link }}">
        <img height="150" width="150" alt="{{ provider_logo.alt }}" src="{{ provider_logo.source }}" />
    </a>
    {% endif %}

    <div class="column is-one-third">
        {% block main_details %}{% endblock %}
    </div>

    {% if module_version %}
    <div class="column is-one-third">

        {% if not current_module.is_submodule %}
        <div class="box">
            <table class="table">
                <thead>
                    <tr>
                        <th>Module Downloads</th>
                        <th>
                            <span class="tag is-warning is-light">All Versions</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Downloads this week</td>
                        <td id="downloads-week"></td>
                    </tr>
                    <tr>
                        <td>Downloads this month</td>
                        <td id="downloads-month"></td>
                    </tr>
                    <tr>
                        <td>Downloads this year</td>
                        <td id="downloads-year"></td>
                    </tr>
                    <tr>
                        <td>Downloads over all time</td>
                        <td id="downloads-total"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <script>

        </script>
        <div class="box">
            <h5 class="title is-5">Usage</h5>
            <div class="content">
                To use this module:
                <ol>
                    <li>Add the following example to your terraform,</li>
                    <li>Ensure the "{{ EXAMPLE_ANALYTICS_TOKEN }}" placeholder must be replaced with your '{{ ANALYTICS_TOKEN_PHRASE }}',               </li>
                    <li>Add the required inputs - use the '<a onclick="selectModuleTab('usage-builder')">Usage Builder</a>' tab for help and 'Inputs' tab for a full list.</li>
                </ol>
            </div>

            <pre>
module "{{ module.name }}" {
    source  = "{{ server_hostname }}/{{ EXAMPLE_ANALYTICS_TOKEN }}__{{ current_module.registry_id }}"
    version = "{{ module_version.get_terraform_example_version_string() }}"

    # Provide variables here
}</pre>
        </div>
    </div>
    {% endif %}
</div>


<div class="tabs">
    <ul>
        {% if current_module %}
            {% if current_module.get_readme_content() %}
            <li id="module-tab-link-readme" class="module-tab-link"><a onclick="selectModuleTab('readme')">Readme</a></li>
            {% endif %}
            {% if current_module.is_example %}
            <li id="module-tab-link-example-files" class="module-tab-link"><a onclick="selectModuleTab('example-files')">Files</a></li>
            {% endif %}
            <li id="module-tab-link-inputs" class="module-tab-link"><a onclick="selectModuleTab('inputs')">Inputs</a></li>
            <li id="module-tab-link-outputs" class="module-tab-link"><a onclick="selectModuleTab('outputs')">Outputs</a></li>
            <li id="module-tab-link-providers" class="module-tab-link"><a onclick="selectModuleTab('providers')">Provider Requirements</a></li>
            <li id="module-tab-link-resources" class="module-tab-link">
                <a onclick="selectModuleTab('resources')">Resources</a>
            </li>

            {% if not current_module.is_submodule %}
                <li id="module-tab-link-analytics" class="module-tab-link">
                    <a onclick="selectModuleTab('analytics')">
                        Analytics
                        {% if not config.DISABLE_TERRAREG_EXCLUSIVE_LABELS %}
                        <span class="tag is-warning is-light">Terrareg Exclusive</span>
                        {% endif %}
                    </a>
                </li>
                <li id="module-tab-link-usage-builder" class="module-tab-link">
                    <a onclick="selectModuleTab('usage-builder')">
                        Usage Builder
                        {% if not config.DISABLE_TERRAREG_EXCLUSIVE_LABELS %}
                        <span class="tag is-warning is-light">Terrareg Exclusive</span>
                        {% endif %}
                    </a>
                </li>
            {% endif %}
        {% endif %}
        <li id="module-tab-link-integrations" class="module-tab-link">
            <a onclick="selectModuleTab('integrations')">
                Integrations
            </a>
        </li>
        <li style="display: none" id="module-tab-link-settings" class="module-tab-link">
            <a onclick="selectModuleTab('settings')">
                Settings
            </a>
        </li>
    </ul>
</div>

<div class="columns">
    <div class="column is-three-fifths is-offset-one-fifth">
        {% if current_module %}
        <div id="module-tab-readme" class="module-tabs content">
            {{ current_module.get_readme_html()|safe }}
        </div>
        <style>
            #module-tab-readme h1, h2, h3, h4 {
                margin-top: 20px;
            }
        </style>

        <script>
            // Add 'table' class to all tables in README
            $('#module-tab-readme').find('table').addClass('table');
            $('#module-tab-readme').find('h1').addClass('subtitle').addClass('is-3');
            $('#module-tab-readme').find('h2').addClass('subtitle').addClass('is-4');
            $('#module-tab-readme').find('h3').addClass('subtitle').addClass('is-5');
            $('#module-tab-readme').find('h4').addClass('subtitle').addClass('is-6');


        </script>
        {% if current_module.is_example %}
        <div id="module-tab-example-files" class="module-tabs" style="display: none;">
            <script>
                function selectExampleFile(file_path) {
                    // Disable 'is-active' flag on all files
                    $('#example-file-list-nav').find('a').each((itx, item) => {
                        let a_obj = $(item);
                        if (a_obj.data('path') == file_path) {
                            item.className = "panel-block is-active";
                        } else {
                            item.className = "panel-block";
                        }
                    });
                    $.ajax({
                        type: "GET",
                        url: `/v1/terrareg/modules/{{ module_version.id }}/example/file/${file_path}`,
                        success: function (data) {
                            $('#example-file-content').html(data);
                        }
                    });
                }

                $(document).ready(function () {
                    $.ajax({
                        type: "GET",
                        url: "/v1/terrareg/modules/{{ module_version.id }}/example/filelist/{{ current_module.path }}",
                        success: function (data) {
                            let first_file_selected = false;
                            data.forEach((example_file) => {
                                $('#example-file-list-nav').append(`
                                    <a class="panel-block" data-path="${example_file.path}" onClick="selectExampleFile('${example_file.path}')">
                                        <span class="panel-icon">
                                            <i class="fa-solid fa-file-code" aria-hidden="true"></i>
                                        </span>
                                        ${example_file.filename}
                                    </a>
                                `);

                                if (first_file_selected == false) {
                                    first_file_selected = true;
                                    selectExampleFile(example_file.path);
                                }
                            });
                        }
                    });
                });
            </script>


            <div class="columns">
                <div class="column is-one-fifths">
                    <nav id="example-file-list-nav" class="panel">
                        <p class="panel-heading">
                        Files
                        </p>
                    </nav>
                </div>

                <div class="column is-four-fifths">
                    <pre>
<code id="example-file-content" class="language-hcl" data-lang="html">
</code>
</pre>
                </div>
            </div>
        </div>
        {% endif %}
        <div id="module-tab-inputs" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Default value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for input in current_module.get_terraform_inputs() %}
                    <tr>
                        <td>
                            {{ input['name'] }}
                        </td>
                        <td>
                            {{ input['description'] }}
                        </td>
                        <td>
                            {{ input['type'] }}
                        </td>
                        <td>
                            {{ input['default'] if not input['required'] else 'Required' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="module-tab-outputs" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for output in current_module.get_terraform_outputs() %}
                    <tr>
                        <td>
                            {{ output['name'] }}
                        </td>
                        <td>
                            {{ output['description'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="module-tab-providers" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Namespace</th>
                        <th>Source</th>
                        <th>Version</th>
                    </tr>
                </thead>
                <tbody>
                    {% for provider in current_module.get_terraform_provider_dependencies() %}
                    <tr>
                        <td>
                            {{ provider['name'] }}
                        </td>
                        <td>
                            {{ provider['namespace'] }}
                        </td>
                        <td>
                            {{ provider['source'] }}
                        </td>
                        <td>
                            {{ provider['version'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="module-tab-resources" class="module-tabs" style="display: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Provider</th>
                        <th>Source</th>
                        <th>Mode</th>
                        <th>Version</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resource in current_module.get_terraform_resources() %}
                    <tr>
                        <td>
                            {{ resource['type'] }}
                        </td>
                        <td>
                            {{ resource['name'] }}
                        </td>
                        <td>
                            {{ resource['provider'] }}
                        </td>
                        <td>
                            {{ resource['source'] }}
                        </td>
                        <td>
                            {{ resource['mode'] }}
                        </td>
                        <td>
                            {{ resource['version'] }}
                        </td>
                        <td>
                            {{ resource['description'] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not current_module.is_submodule %}
        <div id="module-tab-analytics" class="module-tabs" style="display: none;">
            <table id="analytics-table" class="table" style="width: 100%">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Module Version</th>
                        <th>Terraform Version</th>
                        <th>Environment</th>
                    </tr>
                </thead>
                <tbody id="analyticsVersionByTokenTable">
                </tbody>
            </table>
        </div>

        <div id="module-tab-usage-builder" class="module-tabs" style="display: none;">
            <span>Provide values to the following inputs to generate terraform required to use the module.</span>
            <table id="analytics-table" class="table" style="width: 100%">
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Description</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="usageBuilderTable">
                    <tr>
                        <td>{{ ANALYTICS_TOKEN_PHRASE }}</td>
                        <td>{{ ANALYTICS_TOKEN_DESCRIPTION }}</td>
                        <td>
                            <input class="input" onkeyup="updateUsageBuilderOutput();"
                                   id="usageBuilderAnalyticsToken" type="text"
                                   placeholder="{{ EXAMPLE_ANALYTICS_TOKEN }}" />
                        </td>
                    </tr>
                </tbody>
            </table>
            <pre id="usageBuilderOutput">
</pre>

        </div>
        {% endif %}
        {% endif %}

        <!-- Index version tab -->
        <div id="module-tab-integrations" class="module-tabs" style="display: none;">
            <script>
                function indexModuleVersion() {
                    let moduleVersionToIndex = $('#indexModuleVersion').val();
                    $.post(
                        `/v1/terrareg/modules/{{ module_provider.id }}/${moduleVersionToIndex}/import`
                    ).done(() => {
                        $('#index-version-success').html('Successfully indexed version');
                        $('#index-version-success').css('display', 'block');
                        $('#index-version-error').css('display', 'none');
                        if ($('#indexModuleVersionPublish').is(':checked')) {
                            $.post(
                                `/v1/terrareg/modules/{{ module_provider.id }}/${moduleVersionToIndex}/publish`
                            ).done(() => {
                                $('#index-version-success').html('Successfully indexed and published version.');
                            }).fail((res) => {
                                if (res.responseJSON && res.responseJSON.message) {
                                    $('#index-version-error').html(res.responseJSON.message);
                                } else {
                                    $('#index-version-error').html('An unexpected error occurred when publishing module version');
                                }
                                $('#index-version-error').css('display', 'block');
                            });
                        }
                    }).fail((res) => {
                        if (res.responseJSON && res.responseJSON.message) {
                            $('#index-version-error').html(res.responseJSON.message);
                        } else {
                            $('#index-version-error').html('An unexpected error occurred when indexing module');
                        }
                        $('#index-version-error').css('display', 'block');
                    });
                }
            </script>
            <p class="subtitle">
                Integrations
            </p>

            API endpioints
            <table class="table">
                {% if ALLOW_MODULE_HOSTING %}
                <tr>
                    <td>Create module version using source archive</td>
                    <td>
                        <code>POST https://{{ server_hostname }}/v1/terrareg/modules/{{ module_provider.id }}/${version}/upload</code><br />
                        Source ZIP file must be provided as data.
                    </td>
                </tr>
                {% endif %}
                <tr>
                    <td>Trigger module version import</td>
                    <td><code>POST https://{{ server_hostname }}/v1/terrareg/modules/{{ module_provider.id }}/${version}/import</code></td>
                </tr>
                <tr>
                    <td>Bitbucket hook trigger</td>
                    <td><code>https://{{ server_hostname }}/v1/terrareg/modules/{{ module_provider.id }}/hooks/bitbucket</code></td>
                </tr>
                <tr>
                    <td>Github hook trigger <b>(coming soon)</b></td>
                    <td><code>https://{{ server_hostname }}/v1/terrareg/modules/{{ module_provider.id }}/hooks/github</code></td>
                </tr>
                <tr>
                    <td>Gitlab hook trigger <b>(coming soon)</b></td>
                    <td><code>https://{{ server_hostname }}/v1/terrareg/modules/{{ module_provider.id }}/hooks/gitlab</code></td>
                </tr>
                <tr>
                    <td>Mark module version as published</td>
                    <td><code>POST https://{{ server_hostname }}/v1/terrareg/modules/{{ module_provider.id }}/${version}/publish</code></td>
                </tr>

            </table>

            <div id="index-version-success" style="display: none" class="notification is-success">
                Successfully indexed version
            </div>
            <div id="index-version-error" style="display: none" class="notification is-danger">
            </div>
            Manually index version
            <div class="field is-vertical">
                <label class="label">Version</label>
                <div class="control">
                    <input id="indexModuleVersion" class="input is-small" type="text" size="5" placeholder="1.0.0">
                </div>
                <label class="checkbox">
                    <input id="indexModuleVersionPublish" type="checkbox" value="true">
                    Publish
                </label>
                <div class="control">
                    <a onclick="indexModuleVersion();" class="button is-info is-small">
                    Index Version
                    </a>
                </div>
            </div>
        </div>

        <!-- Module settings tab -->
        <div id="module-tab-settings" class="module-tabs" style="display: none;">
            <div class="field is-vertical">
                <div id="settings-status-success" style="display: none" class="notification is-success">
                    Settings Updated
                </div>
                <div id="settings-status-error" style="display: none" class="notification is-danger">
                </div>
                <form onsubmit="update_module_provider_settings(event); event.preventDefault();">
                    <div class="field">
                        <label class="label">Verified</label>
                        <div class="control">
                            <input class="checkbox" type="checkbox" value="true" id="settings-verified"
                                {% if module_provider.verified %}checked{% endif %}>
                        </div>
                        {% if namespace.is_auto_verified %}
                        All modules within this namespace are automatically approved on creation.
                        {% endif %}
                    </div>

                    <div class="field">
                        <label class="label">Git Repository Provider</label>
                        <div class="control select">
                            <select id="settings-git-provider">

                                {% if ALLOW_CUSTOM_GIT_URL_MODULE_PROVIDER or ALLOW_CUSTOM_GIT_URL_MODULE_VERSION %}
                                <option value=""
                                        {% if not module_provider.get_git_provider() %}
                                        selected
                                        {% endif %}>
                                    Custom
                                </option>
                                {% endif %}

                                {% for git_provider in git_providers %}
                                <option
                                    value="{{ git_provider.pk }}"
                                    {% if module_provider.get_git_provider() and
                                        module_provider.get_git_provider().name == git_provider.name
                                        %}selected{% endif %}>

                                    {{ git_provider.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    {% if ALLOW_CUSTOM_GIT_URL_MODULE_PROVIDER %}
                    <div class="field">
                        <label class="label">Custom Repository base URL</label>
                        <div class="control">
                            <input placeholder="https://github.com/{{ namespace.name }}/{{ module.name }}-{{ module_provider.name }}" class="input" type="text" value="{{ module_provider._get_db_row()['repo_base_url_template'] or '' }}" id="settings-base-url-template">
                        </div>
                        This URL must be valid for browsing the base of the repository.<br />
                        It may include templated values, such as: <code>{namespace}</code>, <code>{module}</code>, <code>{provider}</code>.<br />
                        E.g. <code>https://github.com/{namespace}/{module}-{provider}</code><br />
                        NOTE: Setting this field will override the repository provider configuration.
                    </div>
                    <div class="field">
                        <label class="label">Custom Repository Clone URL</label>
                        <div class="control">
                            <input placeholder="ssh://git@github.com/{{ namespace.name }}/{{ module.name }}-{{ module_provider.name }}.git" class="input" type="text" value="{{ module_provider._get_db_row()['repo_clone_url_template'] or '' }}" id="settings-clone-url-template">
                        </div>
                        This URL must be valid for cloning the repository.<br />
                        It may include templated values, such as: <code>{namespace}</code>, <code>{module}</code>, <code>{provider}</code>>.<br />
                        E.g. <code>ssh://git@github.com/{namespace}/{module}-{provider}.git</code><br />
                        NOTE: Setting this field will override the repository provider configuration.
                    </div>
                    <div class="field">
                        <label class="label">Custom Repository source browse URL</label>
                        <div class="control">
                            <input placeholder="https://github.com/{{ namespace.name }}/{{ module.name }}-{{ module_provider.name }}/tree/{tag}/{path}" class="input" type="text" value="{{ module_provider._get_db_row()['repo_browse_url_template'] or '' }}" id="settings-browse-url-template">
                        </div>
                        This URL must be valid for browsing the source code of the repository at a particular tag/path.<br />
                        It may include templated values, such as: <code>{namespace}</code>, <code>{module}</code>, <code>{provider}</code>.<br />
                        It must include the following template values: <code>code>{tag}</code> and {path}</code><br />
                        E.g. <code>https://github.com/{namespace}/{module}-{provider}/tree/{tag}/{path}</code><br />
                        NOTE: Setting this field will override the repository provider configuration.
                    </div>
                    {% endif %}

                    <div class="field">
                        <label class="label">Git tag format</label>
                        <div class="control">
                            <input placeholder="v{version}" class="input" type="text" value="{{ module_provider.git_tag_format or '' }}" id="settings-git-tag-format">
                        </div>
                        This value will be converted to the expected git tag for a module version.<br />
                        {version} will be replaced by the actual module version.<br />
                        For example <code>v{version}</code> will translate to a git tag 'v1.1.1' for module version '1.1.1'
                    </div>
    
                    <div class="field">
                        <div class="control">
                        <button class="button is-link">Update</button>
                        </div>
                    </div>
                </form>
            </div>
            {% if module_version %}
            <div class="field is-vertical">
                <script>
                    function deleteModuleVersion() {
                        $('#confirm-delete-module-version-div').css('display', 'block');
                        if (! $('#confirm-delete-module-version').is(':checked')) {
                            return;
                        }
                        $.ajax({
                            url: '/v1/terrareg/modules/{{ module_version.id }}/delete',
                            method: 'delete',
                            data: JSON.stringify({
                                csrf_token: '{{ csrf_token }}'
                            }),
                            contentType: 'application/json'
                        }).done(()=> {
                            // Reidrect to module provider page.
                            // This will automatically redirect back
                            // down the path to valid existing object.
                            window.location.href = '/modules/{{ module_provider.id }}';
                        });
                    }
                </script>
                <div class="control">
                    <button id="module-version-delete-button" onclick="deleteModuleVersion();" class="button is-link is-danger">Delete Module Version: {{ module_version.version }} </button>
                </div>
                <br />
                <div id="confirm-delete-module-version-div" style="display: none;">
                    Confirm deletion of module version {{ module_version.version }}: <input autocomplete="off" id="confirm-delete-module-version" type="checkbox" />
                </div>
            </div>
            {% endif %}
            <div class="field is-vertical">
                <script>
                    function deleteModule() {
                        $('#confirm-delete-module-provider-div').css('display', 'block');
                        if (! $('#confirm-delete-module-provider').is(':checked')) {
                            return;
                        }
                        $.ajax({
                            url: '/v1/terrareg/modules/{{ module_provider.id }}/delete',
                            method: 'delete',
                            data: JSON.stringify({
                                csrf_token: '{{ csrf_token }}'
                            }),
                            contentType: 'application/json'
                        }).done(()=> {
                            // Reidrect to module page.
                            // This will automatically redirect back
                            // down the path to valid existing object.
                            window.location.href = '/modules/{{ module.id }}';
                        });
                    }
                </script>
                <div class="control">
                    <button id="module-provider-delete-button" onclick="deleteModule();" class="button is-link is-danger">Delete Module Provider</button>
                </div>
                <br />
                <div id="confirm-delete-module-provider-div" style="display: none;">
                    Confirm deletion of module provider: <input autocomplete="off" id="confirm-delete-module-provider" type="checkbox" />
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_module %}

<script>
    var input_variables;

    function usageBuilderQuoteString(input) {
        // Place input value directly into double quotes.
        // Escape backslashes and then escape double quotes.
        return '"' + input.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"';
    }

    function updateUsageBuilderOutput() {
        let output_tf = '';
        let additional_content = '';

        let analytics_token = $('#usageBuilderAnalyticsToken')[0].value;

        input_variables.forEach((input_variable) => {
            let input_id = `#usageBuilderInput-${input_variable.name}`;
            let var_input = '';

            // Get value from
            if (input_variable.type == 'static')
            {
                var_input = input_variable.value;
            }
            else if (input_variable.type == 'text')
            {
                var_input = $(input_id)[0].value;
            }
            else if (input_variable.type == 'boolean')
            {
                var_input = $(input_id).is(':checked') ? 'true' : 'false';
            }
            else if (input_variable.type == 'select')
            {
                let select_index = $(input_id)[0].value;
                let custom_input_id = `${input_id}-customValue`;

                // Check if custom type
                if (select_index == 'custom') {
                    // Display custom text input
                    $(custom_input_id)[0].style.display ='block';

                    // Use value of custom input as output
                    var_input = $(custom_input_id)[0].value
                }
                else
                {
                    // Hide custom input and clear value
                    $(custom_input_id)[0].style.display = 'none';
                    $(custom_input_id)[0].value = '';

                    // If choice is a string, add the choice name to as the value
                    if (typeof input_variable.choices[select_index] === 'string') {
                        var_input = input_variable.choices[select_index];
                    } else {
                        // Otherwise, use the attribute for the value
                        var_input = input_variable.choices[select_index].value;

                        // If object has additional_content, add it to the TF output
                        if (input_variable.choices[select_index].additional_content) {
                            additional_content += input_variable.choices[select_index].additional_content + '\n\n';
                        }
                    }
                }
                
            }

            if (input_variable.quote_value) {
                var_input = usageBuilderQuoteString(var_input);
            }

            output_tf += `\n    ${input_variable.name} = ${var_input}`;
        });


        $('#usageBuilderOutput').html(`${additional_content}module "{{ module.name }}" {
    source  = "{{ server_hostname }}/${analytics_token}__{{ current_module.registry_id }}"
    version = "{{ module_version.get_terraform_example_version_string() }}"
${output_tf}
}`);
    }

    $.get("/v1/terrareg/modules/{{ module_version.id }}/variable_template", (data, status) => {
        // Populate input_variables from response
        input_variables = data;

        if (! input_variables.length) {
            $('#module-tab-link-usage-builder').remove();
            return;
        }

        // Build input table
        input_variables.forEach((input_variable) => {
            let input_html = '';
            let input_id = `usageBuilderInput-${input_variable.name}`;

            if (input_variable.type == 'text') {
                input_html = `<input onkeyup="updateUsageBuilderOutput();" class="input" type="text" id="${input_id}" />`;

            } else if (input_variable.type == 'boolean') {
                input_html = `<input onchange="updateUsageBuilderOutput();" class="checkbox" type="checkbox" id="${input_id}" value="true">`;

            } else if (input_variable.type == 'select') {
                input_html = `<div class="select"><select onchange="updateUsageBuilderOutput();" id="${input_id}">`;
                input_variable.choices.forEach((input_choice, itx) => {
                    // If choices is list of strings, use the string as the name,
                    // otherwise, use name attribute of object.
                    let input_name = typeof input_choice === 'string' ? input_choice : input_choice.name;
                    input_html += `<option value="${itx}">${input_name}</option>`;
                });
                // If custom input is available, add to select
                if (input_variable.allow_custom) {
                    input_html += `<option value="custom">Custom Value</option>`;
                }
                input_html += '</select></div>';

                // If custom input is available, add hidden input for custom input
                input_html += `<input class="input" type="text" id="${input_id}-customValue" onkeyup="updateUsageBuilderOutput();" style="display: none;">`;

            } else {
                // Skip displaying other types of variables in input
                return;
            }

            $('#usageBuilderTable').append(`
                <tr>
                    <td>${input_variable.name}</td>
                    <td>${input_variable.additional_help === undefined ? '' : input_variable.additional_help}</td>
                    <td>${input_html}</td>
                </tr>
            `);
        });
    });
</script>
{% endif %}
<script>

    // Check if user is authenticated and display settings tab
    is_logged_in((logged_in) => {
        if (logged_in) {
            $('#module-tab-link-settings').css('display', 'block');
        }
    });
</script>



{% endblock %}

{% block additional_footer %}
<p>
    {% if provider_logo.exists %}
    {{ provider_logo.tos }}
    {% endif %}
</p>
{% endblock %}
